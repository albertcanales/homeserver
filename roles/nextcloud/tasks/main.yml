---
- name: Configure Nextcloud service
  docker_compose:
    project_name: nextcloud
    pull: "{{ update_images }}"
    definition:
      version: '2'
      services:
        db:
          container_name: nextcloud-db
          image: mariadb:10.6
          restart: always
          command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
          volumes:
            - nextcloud-db:/var/lib/mysql
          environment:
            - "MYSQL_ROOT_PASSWORD={{ nextcloud_root_db_password }}"
            - "MYSQL_PASSWORD={{ nextcloud_db_password }}"
            - MYSQL_DATABASE=nextcloud
            - MYSQL_USER=nextcloud
        app:
          container_name: nextcloud-app
          image: nextcloud
          restart: always
          ports:
            - 500:80
          links:
            - db
          volumes:
            - nextcloud-nextcloud:/var/www/html
            - type: bind
              source: /data/files
              target: /var/www/html/data
          environment:
            - "MYSQL_PASSWORD={{ nextcloud_db_password }}"
            - MYSQL_DATABASE=nextcloud
            - MYSQL_USER=nextcloud
            - MYSQL_HOST=db
      volumes:
        nextcloud-db:
        nextcloud-nextcloud:
